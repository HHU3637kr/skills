# Spec 驱动式开发 - Skills 体系指南

## 概述

本项目构建了一套完整的 Skills 体系，旨在通过 **Obsidian** 实现 **Spec 驱动式开发**方法论。这套体系将 AI Agent 的能力、结构化的文档管理、和可追溯的开发流程融为一体，形成了一个高效、可维护的开发工作流。

## 核心理念

> **Spec First** - 一切从 Spec 开始
> - 先设计，后实现
> - 严格遵循 Spec，不添加额外功能
> - 每个实现都可追溯到 Spec 文档
> - 完整的开发过程记录在 Obsidian 中

## 架构概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Spec 驱动式开发工作流                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐ │
│  │ spec-writer │ → │ spec-execu- │ → │ spec-review │ → │   归档/     │ │
│  │             │   │   tor       │   │   er        │   │   更新      │ │
│  │ 创建 plan.md│   │ 执行实现    │   │ 生成审查    │   │   06-已归档 │ │
│  └─────────────┘   └─────────────┘   └─────────────┘   └─────────────┘ │
│         ↓                                    ↓                          │
│    用户确认                            用户确认审查报告                  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │                    Obsidian 作为核心存储                        │  │
│  │  • Markdown 文档（plan.md, summary.md, review.md）             │  │
│  │  • 双链建立文档关联                                              │  │
│  │  • Frontmatter 管理元数据                                         │  │
│  │  • Callout 突出关键信息                                           │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## Skills 体系组成

### 1. Spec 核心工作流 Skills

这套 Skills 实现了完整的 Spec 驱动开发流程：

| Skill | 功能 | 使用场景 |
|-------|------|----------|
| `spec-writer` | 撰写技术规格文档（plan.md） | 创建新功能 Spec |
| `spec-executor` | 执行新功能开发 | 基于 plan.md 首次实现 |
| `spec-updater` | 执行功能更新 | 修改已有功能（不归档） |
| `spec-reviewer` | 审查实现情况 | 验证是否严格遵循 Spec |

#### 新功能开发流程

```
用户提出需求
    ↓
【intent-confirmation】确认用户意图 ⚠️
- 需求描述是否清晰？
- 技术方案是否明确？
- 是否有多种理解方式？
    ↓
spec-writer 创建 plan.md
（放入 spec/01-05 分类目录）
    ↓
用户确认 Spec
    ↓
spec-executor 执行实现
    ↓
spec-executor 创建 summary.md
    ↓
spec-reviewer 审查实现
    ↓
spec-reviewer 生成 review.md
    ↓
用户阅读并确认审查报告
    ↓
移动到 spec/06-已归档
```

> **⚠️ 为什么需要 intent-confirmation？**
>
> 在执行非简单任务前，必须先确认用户意图，避免因理解偏差导致的无效工作。触发条件包括：
> - **抽象需求**：需求描述较为模糊（如"优化一下这个功能"）
> - **设计决策**：涉及架构变更或设计选择
> - **多义表达**：用户表达可能有多种理解
> - **大范围影响**：任务影响范围较大

#### 功能更新流程

```
发现需要修改已有功能
    ↓
【intent-confirmation】确认更新意图 ⚠️
- 更新范围是否明确？
- 是否影响现有功能？
- 是否需要回归测试？
    ↓
spec-writer 创建 update-xxx.md
（放在原 Spec 目录）
    ↓
用户确认更新方案
    ↓
spec-updater 执行更新
    ↓
spec-updater 创建 update-xxx-summary.md
    ↓
spec-reviewer 审查更新
    ↓
spec-reviewer 生成 review-xxx.md
    ↓
用户确认
    ↓
完成（不归档，保留在原目录）
```

### 2. Obsidian 支持 Skills

| Skill | 功能 | 在 Spec 流程中的作用 |
|-------|------|---------------------|
| `obsidian-markdown` | 创建和编辑 Obsidian Flavored Markdown | 所有 Spec 文档的格式基础 |
| `obsidian-bases` | 创建和管理数据库视图 | 动态 Spec 索引、状态跟踪 |
| `json-canvas` | 创建可视化 Canvas | Spec 依赖关系图、架构图 |

### 3. 辅助 Skills

| Skill | 功能 | 在 Spec 流程中的作用 |
|-------|------|---------------------|
| `intent-confirmation` | 确认用户意图 | **在执行任务前**避免理解偏差，确保 Agent 正确理解需求 |
| `git-workflow-sop` | Git 操作规范 | 提交代码、同步仓库 |
| `memory` | 项目长时记忆管理 | 记录「困境-策略」对、SOP |
| `skill-creator` | 创建新 Skill 的指南 | 扩展能力时参考 |

## Spec 目录结构

```
spec/
├── 01-项目规划/          # PRD、流程设计、项目规划
├── 02-架构设计/          # 架构、数据模型、服务层
├── 03-功能实现/          # 功能、API、集成
├── 04-问题修复/          # Bug修复、重构
├── 05-测试文档/          # 测试计划、测试报告
└── 06-已归档/           # 已完成的 Spec（自动移动）
```

每个 Spec 目录遵循以下命名规范：
```
spec/分类目录/YYYYMMDD-HHMM-任务描述/
├── plan.md                    # 设计方案（spec-writer 创建）
├── summary.md                 # 实现总结（spec-executor 创建）
├── review.md                  # 审查报告（spec-reviewer 创建）
├── update-001.md              # 更新方案（spec-writer 创建）
├── update-001-summary.md      # 更新总结（spec-updater 创建）
└── review-001.md              # 更新审查（spec-reviewer 创建）
```

## Obsidian 在 Spec 流程中的关键作用

### 1. 双链建立文档关联

使用 `[[wikilink]]` 语法建立文档间的关系：

```markdown
## 文档关联

- 设计文档: [[plan|设计方案]]
- 实现总结: [[summary|实现总结]]
- 审查报告: [[review|审查报告]]
```

**优势**：
- 文档关联可视化（在 Obsidian 的关系图中查看）
- 快速导航到相关文档
- 自动反向链接追踪

### 2. Frontmatter 元数据管理

每个 Spec 文档使用 YAML frontmatter 存储元数据：

```yaml
---
title: 功能名称
type: plan
category: 03-功能实现
status: 未确认
priority: 高
created: 2026-01-09
tags:
  - spec
  - plan
related: []
---
```

**优势**：
- 支持结构化查询和过滤
- 与 obsidian-bases 无缝集成
- 便于生成索引和统计

### 3. Callout 突出关键信息

使用 Callout 语法突出不同类型的信息：

```markdown
> [!warning] 注意事项
> 这个实现必须保证可追溯性

> [!tip] 最佳实践
> 优先使用异步操作处理并发

> [!success] 已完成
> 所有功能已按计划实现
```

### 4. 动态索引（obsidian-bases）

使用 `.base` 文件创建动态 Spec 索引：

```yaml
filters:
  and:
    - file.inFolder("spec")
    - 'file.ext == "md"'
    - 'status != "已归档"'

views:
  - type: table
    name: "进行中的 Spec"
    order:
      - file.name
      - status
      - priority
```

## 完整工作流示例

### 示例：实现「专业评价 Agent」

#### 步骤 1：创建 Spec（spec-writer）

```bash
用户：我需要实现一个专业评价 Agent

Claude（调用 spec-writer）：
正在创建 plan.md...
路径：spec/03-功能实现/20260109-1430-专业评价Agent设计/plan.md

Spec 已创建，内容包括：
- 需求分析
- 数据模型设计
- 接口定义
- 实现步骤
- 测试计划

请审阅并确认后开始实现。
```

#### 步骤 2：用户确认

```bash
用户：确认，开始实现

Claude（调用 spec-executor）：
开始执行实现...
- [x] 实现 IndicatorParser 类
- [x] 实现 MaterialAnalyzer 类
- [x] 实现 EvaluationAgent 类
- [x] 编写单元测试
- [x] 运行测试验证

已创建 summary.md，记录实现总结。
```

#### 步骤 3：审查实现（spec-reviewer）

```bash
Claude（调用 spec-reviewer）：
正在审查实现...

审查结果：
- ✅ 已完成：8/8 项功能
- ❌ 未完成：0 项
- ⚠️ 不符项：0 项
- ➕ 额外项：0 项

已生成 review.md 审查报告。
请确认后归档到 06-已归档。
```

#### 步骤 4：用户确认并归档

```bash
用户：确认归档

Claude（调用 spec-executor 归档流程）：
正在移动 Spec 文件夹到 06-已归档...
归档完成！
```

## 记忆系统

本项目实现了基于 **MUSE 框架** 的三层记忆架构，支持 AI Agent 的长期学习和经验积累：

```
┌─────────────────────────────────────────────────────────────────┐
│                     MUSE 记忆架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐   ┌──────────────────┐   ┌─────────────┐ │
│  │   战略记忆       │   │   程序记忆       │   │  工具记忆   │ │
│  │  CLAUDE.md      │   │  独立 Skill     │   │Skill 末尾   │ │
│  │  全量加载       │   │  按需加载       │   │自动参考     │ │
│  └──────────────────┘   └──────────────────┘   └─────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 三层记忆详解

#### 1. 战略记忆 → CLAUDE.md

**存储位置**：项目根目录的 `CLAUDE.md`

**加载方式**：全量注入系统提示词（始终加载）

**存储格式**：
```markdown
## 战略记忆

### [2026-01-08] 困境标题
- **困境**：遇到了什么问题/挑战
- **策略**：采用了什么解决策略
- **理由**：为什么这个策略有效
```

**写入时机**：
- 重大架构决策后
- 解决了反复出现的困难问题
- 发现了全局性的最佳实践

#### 2. 程序记忆 → 独立 Skill

**存储位置**：`.claude/skills/sop-xxx/SKILL.md`

**加载方式**：
- Skill 的 `description` 作为索引（始终可见）
- Skill 的正文作为 SOP 内容（触发时才加载）

**存储格式**：
```markdown
---
name: sop-xxx
description: [简短描述] 触发条件：[什么时候使用]
---

# SOP: [操作名称]

## 前置条件
...

## 执行步骤
...

## 后续动作（工具记忆）
...
```

**写入时机**：
- 完成了可复用的多步骤操作
- 发现了重复的操作模式
- 用户明确要求记录 SOP

**示例**：`sop-001-agentscope-hook-state` - AgentScope Hook 状态管理 SOP

#### 3. 工具记忆 → Skill 末尾

**存储位置**：每个 Skill 文件的末尾「后续动作」章节

**加载方式**：随 Skill 一起加载，执行完 Skill 后自动参考

**存储格式**：
```markdown
## 后续动作（工具记忆）

完成本操作后，你应该：
1. [具体的下一步动作]
2. [需要检查的事项]
3. [可能需要调用的其他 Skill]
```

**写入时机**：
- 发现某个操作后总是需要特定的后续步骤
- 工具调用有固定的检查或验证模式
- 一个 Skill 执行后经常需要调用另一个 Skill

### 记忆更新机制

系统支持三种记忆更新方式，根据新内容与现有内容的关系自动选择：

```
┌─────────────────────────────────────────────────────────────────┐
│                    记忆更新方式决策                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  第一步：判断新内容与现有内容的关系                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Q1: 新内容是否与现有内容冲突或需要纠正？                  │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ A. 是，现有内容错误或过时 → 覆盖更新             │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ B. 否，内容互补或无关 → 继续判断                 │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  第二步：判断内容性质（仅当 Q1 选 B 时）                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Q2: 内容是"操作过程规范"还是"操作后动作"？                │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ A. 操作过程中应遵循的规范                         │    │   │
│  │  │    → 检查记忆类型                                │    │   │
│  │  │       • 程序记忆/工具记忆 → 嵌入更新             │    │   │
│  │  │       • 战略记忆 → 不适用，转为增量更新           │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  │                                                          │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │ B. 操作完成后的动作或内容                         │    │   │
│  │  │    → 增量更新                                    │    │   │
│  │  └─────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 更新方式详解

| 方式 | 说明 | 适用场景 | 示例 |
|------|------|----------|------|
| **嵌入更新** | 将内容嵌入到操作步骤中 | 操作过程规范 | 在撰写文档步骤中嵌入格式规范 |
| **增量更新** | 在现有内容基础上新增 | 内容互补、不冲突 | 添加新的「困境-策略」对 |
| **覆盖更新** | 替换现有内容 | 现有内容错误或过时 | 修正错误的解决方案 |

#### 防止重复记忆规则

系统内置防止重复机制：

**战略记忆去重**：
- 检查 CLAUDE.md 中是否已存在相同或相似的「困境」
- 相似性判断标准：困境描述的核心问题相同、策略的主要方法相同

**程序记忆去重**：
- 检查是否已存在相同或相似的 SOP Skill
- 相似性判断标准：SOP 名称相似、触发条件相同、核心步骤相同

**工具记忆去重**：
- 检查 Skill 的「后续动作」章节是否已存在相同动作
- 如存在但不完整，则补充完善

### 使用 /memory Skill

**手动触发**：
```bash
/memory              # 进入记忆管理模式，分析当前对话
/memory reflect     # 触发反思，提取可记录的经验
/memory strategic   # 查看 CLAUDE.md 中的战略记忆
/memory sop         # 列出所有 SOP Skill
```

**自动提示**：
- 解决了反复出现的困难问题
- 做出了重要的架构或技术决策
- 完成了一个多步骤的复杂操作（>5 步）
- 发现某个操作后总是需要特定的后续步骤

## 最佳实践

### 1. Spec 撰写原则

- **明确性**：需求和设计必须清晰明确
- **完整性**：包含所有必要的技术细节
- **可追溯性**：设计决策要有依据
- **可实施性**：提供具体的实现步骤

### 2. 开发约束

- **Spec 优先**：只实现 Spec 中定义的功能
- **开发顺序**：Framework 服务层 → Agent 层 → API 层
- **严格遵循**：不添加 Spec 中未定义的功能
- **可追溯性**：每个功能都能追溯到 Spec 的具体章节

### 3. 文档管理

- **命名规范**：`YYYYMMDD-HHMM-任务描述`
- **分类存放**：必须放入对应的分类目录（01-05）
- **双链关联**：使用 `[[wikilink]]` 建立文档关系
- **元数据完整**：每个文档都有完整的 frontmatter

### 4. 质量把关

- **意图确认**：**第一步**就使用 `intent-confirmation` 避免理解偏差
  - 触发条件：抽象需求、设计决策、多义表达、大范围影响
  - 确认方式：复述用户意图、列出关键理解点、询问"是这个意思吗？"
- **用户确认**：每个关键节点都等待用户确认
- **审查机制**：`spec-reviewer` 验证实现是否符合 Spec
- **防止重复**：`memory` Skill 检查是否已存在相似经验

## 快速上手

### 新成员入门流程

1. **理解 Spec 驱动开发理念**
   - 阅读 CLAUDE.md 了解项目背景
   - 阅读 spec/ 目录下现有 Spec 了解文档风格

2. **熟悉 Skills 工作流**
   - 阅读 spec-writer 了解如何创建 Spec
   - 阅读 spec-executor 了解如何执行实现
   - 阅读 spec-reviewer 了解如何审查实现

3. **配置 Obsidian**
   - 安装 Obsidian（如需要本地查看）
   - 安装 Obsidian Base 插件（支持 .base 文件）
   - 打开项目根目录作为 Vault

4. **开始第一个 Spec**
   - 使用 spec-writer 创建 plan.md
   - 等待用户确认
   - 使用 spec-executor 执行实现
   - 使用 spec-reviewer 审查实现

### 常见命令速查

```bash
# 在 Claude Code 中调用 Skills

/spec-writer      # 创建 Spec 文档
/spec-executor    # 执行新功能开发
/spec-updater     # 执行功能更新
/spec-reviewer    # 审查实现情况

/memory           # 进入记忆管理模式
/intent-confirmation  # 确认用户意图
```

## 技术栈

- **AI Agent**: Claude Code (Anthropic)
- **文档系统**: Obsidian
- **版本控制**: Git
- **文档格式**: Obsidian Flavored Markdown
- **数据格式**: YAML (frontmatter), JSON (canvas)

## 参考资源

### 内部文档

- `CLAUDE.md` - 项目总体指南
- `spec/` - 所有 Spec 文档
- `.claude/skills/*/SKILL.md` - 各 Skill 的详细说明

### 外部资源

- [Obsidian Help](https://help.obsidian.md/)
- [Obsidian Bases Syntax](https://help.obsidian.md/bases/syntax)
- [JSON Canvas Spec](https://jsoncanvas.org/spec/1.0/)
- [Claude Code Documentation](https://claude.ai/code)

## 维护说明

### 添加新 Skill

1. 参考 `skill-creator/SKILL.md` 的指南
2. 在 `.claude/skills/` 下创建新目录
3. 编写 SKILL.md 文件
4. 更新本 README 的 Skills 列表

### 更新现有 Skill

1. 直接编辑对应 Skill 的 SKILL.md
2. 遵循 Skill 的更新规范
3. 更新相关文档引用

---

**版本**: 1.0
**最后更新**: 2026-01-09
**维护者**: 项目团队
