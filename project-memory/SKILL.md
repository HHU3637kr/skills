---
name: project-memory
description: 项目长时记忆管理，自动分析对话上下文并记录关键项目知识（架构决策、代码约定、问题解决方案等）。手动触发：/memory，自动提示：在重要决策或问题解决后。
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
model: claude-sonnet-4-5
---

# Project Memory - 项目长时记忆元 Skill

## 概述

这是一个**元 Skill（Meta Skill）**，用于管理 Agent 的长时记忆系统。它不直接存储记忆，而是**引导 Agent 将经验结构化并写入正确的位置**。

基于 MUSE 框架的"反思 → 结构化 → 记忆化"理念，本 Skill 实现三层记忆架构：

```
┌─────────────────────────────────────────────────────────────────┐
│                     MUSE 记忆架构 in Claude Code                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐   ┌──────────────────┐   ┌─────────────┐ │
│  │   战略记忆       │   │   程序记忆       │   │  工具记忆   │ │
│  │ Strategic Memory │   │ Procedural Memory│   │ Tool Memory │ │
│  └────────┬─────────┘   └────────┬─────────┘   └──────┬──────┘ │
│           │                      │                    │        │
│           ▼                      ▼                    ▼        │
│     CLAUDE.md              独立的 Skill          Skill 末尾    │
│   （全量系统提示词）      （按需加载正文）      （后续动作指引）│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 三层记忆的 Claude Code 实现

### 1. 战略记忆 → CLAUDE.md

**存储位置**：`CLAUDE.md` 的「战略记忆」章节

**加载方式**：全量注入系统提示词（CLAUDE.md 始终加载）

**内容格式**：`<困境, 策略>` 键值对
```markdown
## 战略记忆

### [日期] 困境标题
- **困境**：遇到了什么问题/挑战
- **策略**：采用了什么解决策略
- **理由**：为什么这个策略有效
```

**写入时机**：
- 重大架构决策后
- 解决了反复出现的困难问题
- 发现了全局性的最佳实践

### 2. 程序记忆 → 独立 Skill

**存储位置**：`.claude/skills/sop-xxx/SKILL.md`

**加载方式**：
- Skill 的 `description` 作为索引（始终可见）
- Skill 的正文作为 SOP 内容（触发时才加载）

**内容格式**：标准 Skill 格式，包含 SOP 步骤
```markdown
---
name: sop-xxx
description: [简短描述，作为索引] 触发条件：[什么时候使用]
---

# SOP: [操作名称]

## 前置条件
...

## 执行步骤
...

## 后续动作（工具记忆）
完成本 SOP 后，你应该：
- [下一步动作1]
- [下一步动作2]
```

**写入时机**：
- 完成了可复用的多步骤操作
- 发现了重复的操作模式
- 用户明确要求记录 SOP

### 3. 工具记忆 → Skill 末尾

**存储位置**：每个 Skill 文件的末尾「后续动作」章节

**加载方式**：随 Skill 一起加载，执行完 Skill 后自动参考

**内容格式**：
```markdown
## 后续动作（工具记忆）

完成本操作后，你应该：
1. [具体的下一步动作]
2. [需要检查的事项]
3. [可能需要调用的其他 Skill]
```

**写入时机**：
- 发现某个操作后总是需要特定的后续步骤
- 工具调用有固定的最佳实践模式

---

## 反思工作流

当触发 `/memory` 或 `/memory reflect` 时，执行以下流程：

```
反思工作流：
- [ ] 步骤 1：回溯执行轨迹
      - 回顾本次对话中的所有操作
      - 识别关键决策点和转折点
      - 标记成功/失败的尝试

- [ ] 步骤 2：分析可提取的经验
      - 是否有新的「困境-策略」对？→ 战略记忆
      - 是否形成了可复用的 SOP？→ 程序记忆
      - 是否发现了操作后的固定后续步骤？→ 工具记忆

- [ ] 步骤 3：向用户确认
      - 展示提取的经验
      - 说明将写入的位置
      - 获得用户确认

- [ ] 步骤 4：执行写入
      - 战略记忆 → 编辑 CLAUDE.md
      - 程序记忆 → 创建新 Skill
      - 工具记忆 → 编辑相关 Skill 的末尾

- [ ] 步骤 5：确认完成
      - 告知用户记忆已保存
      - 说明如何触发/使用这些记忆
```

---

## 命令参考

| 命令 | 说明 |
|------|------|
| `/memory` | 进入记忆管理模式，分析当前对话 |
| `/memory reflect` | 触发反思，提取可记录的经验 |
| `/memory strategic` | 查看 CLAUDE.md 中的战略记忆 |
| `/memory sop` | 列出所有 SOP Skill |
| `/memory add strategic` | 添加战略记忆到 CLAUDE.md |
| `/memory add sop` | 创建新的 SOP Skill |

---

## 战略记忆写入指南

### 写入位置

编辑 `CLAUDE.md`，在「战略记忆」章节添加新条目。

### 写入格式

```markdown
### [YYYY-MM-DD] 困境标题

- **困境**：[描述遇到的问题或挑战]
- **策略**：[采用的解决策略]
- **理由**：[为什么这个策略有效]
```

### 示例

```markdown
### [2026-01-08] WebSocket 连接在长时间任务中断开

- **困境**：评估任务执行时间较长（>60s），WebSocket 连接会超时断开
- **策略**：
  1. 增加 Nginx 的 proxy_read_timeout 到 300s
  2. 前端添加心跳机制，每 30s 发送 ping
  3. 后端支持断线重连
- **理由**：三层防护确保连接稳定，即使断开也能恢复
```

### 质量原则

1. **精炼**：每条记忆简洁有力，避免冗余
2. **可操作**：策略必须具体可执行
3. **通用性**：优先记录可复用的经验，而非一次性解决方案

---

## 程序记忆（SOP Skill）创建指南

### 创建位置

`.claude/skills/sop-[编号]-[简短名称]/SKILL.md`

### Skill 模板

```markdown
---
name: sop-[编号]-[简短名称]
description: [一句话描述 SOP 用途]。触发条件：[什么时候使用这个 SOP]
allowed-tools: [需要的工具列表]
---

# SOP: [操作名称]

## 概述

[简要说明这个 SOP 的目的和适用场景]

## 前置条件

- [ ] [条件1]
- [ ] [条件2]

## 执行步骤

### 步骤 1: [步骤名称]

**操作**：[具体操作]

**验证**：[如何验证步骤完成]

**异常处理**：[如果失败怎么办]

### 步骤 2: [步骤名称]

...

## 后置检查

- [ ] [检查项1]
- [ ] [检查项2]

## 常见问题

### Q1: [问题]
A: [答案]

---

## 后续动作（工具记忆）

完成本 SOP 后，你应该：
1. [下一步动作]
2. [需要检查的事项]
3. [可能需要调用的其他 Skill]
```

### 命名规范

- 编号：三位数字，如 `001`、`002`
- 名称：简短的英文或拼音，用连字符分隔
- 示例：`sop-001-spec-driven-dev`、`sop-002-bug-fix`

### 质量原则

1. **可重复**：步骤必须足够详细，能够重复执行
2. **有验证**：每个步骤都有验证方法
3. **有后续**：末尾必须包含「后续动作」章节

---

## 工具记忆嵌入指南

### 嵌入位置

每个 Skill 文件的末尾，作为独立章节。

### 嵌入格式

```markdown
---

## 后续动作（工具记忆）

完成本操作后，你应该：

### 如果成功
1. [成功后的下一步]
2. [需要验证的事项]

### 如果失败
1. [失败后的排查步骤]
2. [可能的替代方案]

### 相关 Skill
- `/sop-xxx` - [相关 SOP 描述]
- `/sop-yyy` - [相关 SOP 描述]
```

### 示例

```markdown
---

## 后续动作（工具记忆）

完成代码提交后，你应该：

### 如果成功
1. 检查 CI/CD 是否触发
2. 如果有 PR，等待 review
3. 考虑是否需要更新文档

### 如果失败
1. 检查 pre-commit hook 的错误信息
2. 修复问题后创建新提交（不要 amend）
3. 如果是权限问题，检查 git 配置

### 相关 Skill
- `/sop-003-git-commit` - 代码提交流程
- `/spec-writer` - 如果需要创建新功能的 Spec
```

---

## 自动提示规则

Agent 应在以下场景**主动询问**是否需要记录：

### 战略记忆触发信号

- 解决了一个反复出现的困难问题
- 做出了重要的架构或技术决策
- 发现了一个全局性的最佳实践
- 用户说"以后都这样处理"

### 程序记忆触发信号

- 完成了一个多步骤的复杂操作（>5 步）
- 发现自己在重复类似的操作序列
- 成功解决了一个需要特定流程的问题
- 用户说"记录一下这个流程"

### 工具记忆触发信号

- 发现某个操作后总是需要特定的后续步骤
- 工具调用有固定的检查或验证模式
- 一个 Skill 执行后经常需要调用另一个 Skill

---

## 与现有 Skill 的协作

### 与 spec-writer 协作

- 创建 Spec 时，可参考 CLAUDE.md 中的战略记忆
- 如果 Spec 创建流程形成固定模式，可提取为 SOP Skill

### 与 spec-executor 协作

- 执行 Spec 时，可参考相关的 SOP Skill
- 执行完成后，可触发反思提取新的经验

### 与 git-workflow-sop 协作

- Git 操作的最佳实践可作为工具记忆嵌入
- 复杂的 Git 流程可提取为独立的 SOP Skill

---

## 示例场景

### 场景 1：添加战略记忆

```
[解决了 WebSocket 连接问题后]

Agent：我注意到我们刚刚解决了一个关于 WebSocket 连接超时的问题。
这是一个「困境-策略」对，建议记录到战略记忆中。

**困境**：WebSocket 在长时间任务中断开
**策略**：三层防护（Nginx 超时 + 心跳 + 重连）

是否将此添加到 CLAUDE.md 的战略记忆章节？

用户：好的

Agent：正在编辑 CLAUDE.md...
已添加战略记忆：[2026-01-08] WebSocket 连接在长时间任务中断开
```

### 场景 2：创建 SOP Skill

```
[完成了一个复杂的部署流程后]

Agent：我注意到这次部署涉及 8 个步骤，形成了一个可复用的流程。
建议创建一个 SOP Skill 来记录这个流程。

**SOP 名称**：sop-004-deployment
**触发条件**：需要部署应用到生产环境
**主要步骤**：
1. 检查测试通过
2. 构建生产版本
3. 备份当前版本
...

是否创建这个 SOP Skill？

用户：是的

Agent：正在创建 .claude/skills/sop-004-deployment/SKILL.md...
已创建 SOP Skill。以后可以通过 `/sop-004-deployment` 触发。
```

### 场景 3：添加工具记忆

```
[发现每次运行测试后都需要检查覆盖率]

Agent：我注意到每次运行测试后，我们都会检查覆盖率报告。
建议将这个后续动作添加到相关 Skill 的工具记忆中。

是否更新 sop-002-bug-fix 的「后续动作」章节？

用户：好的

Agent：正在编辑 .claude/skills/sop-002-bug-fix/SKILL.md...
已添加工具记忆：测试通过后检查覆盖率报告
```

---

## 记忆系统维护

### 定期清理

- 删除过时的战略记忆
- 合并重复的 SOP Skill
- 更新不再适用的工具记忆

### 质量检查

- 战略记忆是否仍然有效？
- SOP 步骤是否需要更新？
- 工具记忆的后续动作是否准确？

### 版本控制

所有记忆文件都随项目代码一起进行 Git 版本管理，确保：
- 记忆的变更可追溯
- 团队成员可共享记忆
- 可以回滚错误的记忆更新
